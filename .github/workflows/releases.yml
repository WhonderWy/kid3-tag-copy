name: Build and Release AppImage

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python 3.12
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download ImageMagick portable binary
        run: |
          # Download the ImageMagick portable "magick" binary
          curl -L -o magick "https://imagemagick.org/download/binaries/magick"  # from official site :contentReference[oaicite:1]{index=1}
          chmod +x magick
          # Put it into PATH
          echo "${{ github.workspace }}" >> $GITHUB_PATH

      - name: Verify ImageMagick
        run: |
          ./magick -version

      - name: Install AppImageTool
        run: |
          wget -qO appimagetool-x86_64.AppImage https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Build AppImage
        run: |
          TAG_VERSION=$(echo $GITHUB_REF | sed 's/refs\/tags\///')
          ./build-appimage.sh $TAG_VERSION

      - name: Upload AppImage to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/kid3-tag-copy-$TAG_VERSION.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
